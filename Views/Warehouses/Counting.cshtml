@{
    ViewData["Title"] = "Stok Sayımı";
}

<div class="page-container">
    <div class="section-header">
        <h1 class="section-title">📦 Stok Sayımı</h1>
        <a href="/Warehouses" class="btn btn-secondary">← Geri Dön</a>
    </div>

    <div class="cards-container" style="max-width: 800px; margin: 0 auto;">
        <form id="countingForm">
            <div class="form-group">
                <label class="form-label">🏭 Depo Seçin</label>
                <select id="warehouseSelect" class="form-select" required>
                    <option value="">Depo seçin</option>
                    @foreach (var warehouse in (List<Warehouse>)ViewBag.Warehouses)
                    {
                        <option value="@warehouse.Id">@warehouse.Name (@warehouse.Code)</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">🔍 Barkod</label>
                <input type="text"
                       id="barcodeInput"
                       class="form-control"
                       placeholder="Barkod okutun"
                       required
                       autofocus>
            </div>

            <div class="form-group">
                <label class="form-label">📊 Miktar</label>
                <input type="number"
                       id="quantityInput"
                       class="form-control"
                       placeholder="Adet girin"
                       min="1"
                       value="1"
                       required>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%;">
                ✅ Stok Ekle
            </button>
        </form>

        <div id="recentScans" style="margin-top: 32px;">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">📋 Son Okumalar</h3>
            <div id="scansList"></div>
        </div>
    </div>
</div>

<script>
    const scans = [];

    document.getElementById('countingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const warehouseId = document.getElementById('warehouseSelect').value;
        const barcode = document.getElementById('barcodeInput').value;
        const quantity = document.getElementById('quantityInput').value;

        const formData = new FormData();
        formData.append('warehouseId', warehouseId);
        formData.append('barcode', barcode);
        formData.append('quantity', quantity);

        try {
            const response = await fetch('/Warehouses/Counting', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                scans.unshift({
                    barcode: barcode,
                    quantity: quantity,
                    time: new Date().toLocaleTimeString('tr-TR')
                });

                updateScansList();

                document.getElementById('barcodeInput').value = '';
                document.getElementById('barcodeInput').focus();

                alert('✅ ' + data.message);
            } else {
                alert('❌ ' + data.message);
            }
        } catch (error) {
            alert('❌ Bir hata oluştu');
            console.error(error);
        }
    });

    function updateScansList() {
        const html = scans.map((scan, index) => `
            <div style="padding: 12px; background: var(--bg-main); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600;">${scan.barcode}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${scan.time}</div>
                </div>
                <div style="font-size: 18px; font-weight: 700; color: var(--success);">
                    +${scan.quantity}
                </div>
            </div>
        `).join('');

        document.getElementById('scansList').innerHTML = html || '<p style="color: var(--text-secondary); text-align: center;">Henüz okuma yapılmadı</p>';
    }
</script>